# ============================================================================
# BigBrotr Docker Compose Configuration
# ============================================================================
# Description: Complete containerized deployment for BigBrotr
# Components: PostgreSQL, PGBouncer (optional), Tor (optional)
# Usage: docker-compose up -d
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # PostgreSQL Database
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: bigbrotr-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: brotr
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data

      # SQL initialization scripts (applied in alphabetical order)
      - ./postgres/init/00_extensions.sql:/docker-entrypoint-initdb.d/00_extensions.sql:ro
      - ./postgres/init/01_utility_functions.sql:/docker-entrypoint-initdb.d/01_utility_functions.sql:ro
      - ./postgres/init/02_tables.sql:/docker-entrypoint-initdb.d/02_tables.sql:ro
      - ./postgres/init/03_indexes.sql:/docker-entrypoint-initdb.d/03_indexes.sql:ro
      - ./postgres/init/04_integrity_functions.sql:/docker-entrypoint-initdb.d/04_integrity_functions.sql:ro
      - ./postgres/init/05_procedures.sql:/docker-entrypoint-initdb.d/05_procedures.sql:ro
      - ./postgres/init/06_views.sql:/docker-entrypoint-initdb.d/06_views.sql:ro
      - ./postgres/init/99_verify.sql:/docker-entrypoint-initdb.d/99_verify.sql:ro

      # PostgreSQL configuration file
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro

    ports:
      - "5432:5432"

    networks:
      - bigbrotr-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d brotr"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Load configuration from file
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]

  # --------------------------------------------------------------------------
  # PGBouncer (Connection Pooler) - OPTIONAL
  # --------------------------------------------------------------------------
  # Enable for high-concurrency scenarios (API with many users, heavy writes)
  # Services connect to pgbouncer:6432 instead of postgres:5432
  # Requires: yaml/core/brotr.pgbouncer.yaml configuration

  # pgbouncer:
  #   image: edoburu/pgbouncer:1.21.0
  #   container_name: bigbrotr-pgbouncer
  #   restart: unless-stopped
  #
  #   volumes:
  #     - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
  #     - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
  #
  #   ports:
  #     - "6432:6432"
  #
  #   networks:
  #     - bigbrotr-network
  #
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -h localhost -p 6432 -U admin"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3

  # --------------------------------------------------------------------------
  # Tor Proxy (SOCKS5) - OPTIONAL
  # --------------------------------------------------------------------------
  # Enable for .onion relay support

  # tor:
  #   image: dperson/torproxy:latest
  #   container_name: bigbrotr-tor
  #   restart: unless-stopped
  #
  #   ports:
  #     - "9050:9050"
  #
  #   networks:
  #     - bigbrotr-network
  #
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl --socks5 localhost:9050 --socks5-hostname localhost:9050 -s https://check.torproject.org/api/ip | grep -q origin"]
  #     interval: 60s
  #     timeout: 15s
  #     retries: 3
  #     start_period: 30s

  # --------------------------------------------------------------------------
  # BigBrotr Initializer Service
  # --------------------------------------------------------------------------
  # Runs once to verify database schema and seed initial data

  initializer:
    build:
      context: ../../
      dockerfile: implementations/bigbrotr/Dockerfile
    container_name: bigbrotr-initializer
    restart: "no"

    environment:
      DB_PASSWORD: ${DB_PASSWORD}

    volumes:
      - ./yaml:/app/yaml:ro
      - ./data:/app/data:ro

    networks:
      - bigbrotr-network

    depends_on:
      postgres:
        condition: service_healthy

    command: ["python", "-m", "services", "initializer", "--docker"]

  # --------------------------------------------------------------------------
  # BigBrotr Finder Service
  # --------------------------------------------------------------------------
  # Discovers relay URLs from database events and external APIs

  finder:
    build:
      context: ../../
      dockerfile: implementations/bigbrotr/Dockerfile
    container_name: bigbrotr-finder
    restart: unless-stopped

    environment:
      DB_PASSWORD: ${DB_PASSWORD}

    volumes:
      - ./yaml:/app/yaml:ro

    networks:
      - bigbrotr-network

    depends_on:
      postgres:
        condition: service_healthy
      initializer:
        condition: service_completed_successfully

    command: ["python", "-m", "services", "finder", "--docker"]

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # --------------------------------------------------------------------------
  # BigBrotr Monitor Service (PENDING)
  # --------------------------------------------------------------------------

  # monitor:
  #   build:
  #     context: ../../
  #     dockerfile: implementations/bigbrotr/Dockerfile
  #   container_name: bigbrotr-monitor
  #   restart: unless-stopped
  #
  #   environment:
  #     DB_PASSWORD: ${DB_PASSWORD}
  #
  #   volumes:
  #     - ./yaml:/app/yaml:ro
  #
  #   networks:
  #     - bigbrotr-network
  #
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     initializer:
  #       condition: service_completed_successfully
  #
  #   command: ["python", "-m", "services", "monitor", "--docker"]

  # --------------------------------------------------------------------------
  # BigBrotr Synchronizer Service (PENDING)
  # --------------------------------------------------------------------------

  # synchronizer:
  #   build:
  #     context: ../../
  #     dockerfile: implementations/bigbrotr/Dockerfile
  #   container_name: bigbrotr-synchronizer
  #   restart: unless-stopped
  #
  #   environment:
  #     DB_PASSWORD: ${DB_PASSWORD}
  #
  #   volumes:
  #     - ./yaml:/app/yaml:ro
  #
  #   networks:
  #     - bigbrotr-network
  #
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     initializer:
  #       condition: service_completed_successfully
  #
  #   command: ["python", "-m", "services", "synchronizer", "--docker"]
  #
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '2.0'
  #         memory: 2G
  #       reservations:
  #         cpus: '0.5'
  #         memory: 512M

# ----------------------------------------------------------------------------
# Networks
# ----------------------------------------------------------------------------
networks:
  bigbrotr-network:
    driver: bridge
    name: bigbrotr-network

# ----------------------------------------------------------------------------
# Volumes
# ----------------------------------------------------------------------------
volumes:
  postgres_data:
    driver: local
    name: bigbrotr-postgres-data

# ============================================================================
# USAGE
# ============================================================================
#
# 1. Setup:
#    cp .env.example .env && nano .env  # Set DB_PASSWORD
#
# 2. Start:
#    docker-compose up -d
#
# 3. With PGBouncer (high concurrency):
#    - Uncomment pgbouncer service above
#    - Copy pgbouncer/userlist.txt.template to pgbouncer/userlist.txt
#    - Generate MD5 hash: echo -n "md5$(echo -n 'YOUR_PASSWORDadmin' | md5sum | cut -d' ' -f1)"
#    - Use yaml/core/brotr.pgbouncer.yaml (connects to pgbouncer:6432)
#
# 4. Verify:
#    docker-compose exec postgres psql -U admin -d brotr -c "\dt"
#
# 5. Logs:
#    docker-compose logs -f
#
# 6. Stop:
#    docker-compose down
#
# 7. Reset (WARNING: deletes data):
#    docker-compose down -v
#
# ============================================================================
