# ============================================================================
# PostgreSQL Configuration for BigBrotr
# ============================================================================
# Optimized for write-heavy workloads (Synchronizer) and read concurrency (API)
# Memory settings assume 2GB container limit (adjust if needed)
# ============================================================================

# ----------------------------------------------------------------------------
# Connection Settings
# ----------------------------------------------------------------------------
max_connections = 200                    # Total connections (via PGBouncer)
superuser_reserved_connections = 3       # Reserved for admin

# ----------------------------------------------------------------------------
# Memory Settings
# ----------------------------------------------------------------------------
# Tuned for 2GB container memory limit
shared_buffers = 512MB                   # 25% of RAM (cache for data)
effective_cache_size = 1536MB            # 75% of RAM (OS cache estimate)
work_mem = 4MB                           # Per-operation memory (sorts, joins)
maintenance_work_mem = 128MB             # VACUUM, CREATE INDEX, etc.

# ----------------------------------------------------------------------------
# Write-Ahead Log (WAL) - Critical for write performance
# ----------------------------------------------------------------------------
wal_buffers = 16MB                       # WAL write buffer
min_wal_size = 1GB                       # Minimum WAL size before recycling
max_wal_size = 4GB                       # Maximum WAL size before checkpoint
checkpoint_completion_target = 0.9       # Spread checkpoint I/O
checkpoint_timeout = 10min               # Time between checkpoints

# ----------------------------------------------------------------------------
# Query Planner
# ----------------------------------------------------------------------------
random_page_cost = 1.1                   # SSD-optimized (1.1 vs 4.0 for HDD)
effective_io_concurrency = 200           # Concurrent I/O operations (SSD)
default_statistics_target = 100          # Statistics sampling

# ----------------------------------------------------------------------------
# Parallel Query Execution
# ----------------------------------------------------------------------------
max_worker_processes = 4                 # Background workers
max_parallel_workers = 4                 # Parallel query workers
max_parallel_workers_per_gather = 2      # Workers per parallel query
max_parallel_maintenance_workers = 2     # Workers for VACUUM, INDEX

# ----------------------------------------------------------------------------
# Write Performance (Synchronizer optimization)
# ----------------------------------------------------------------------------
synchronous_commit = off                 # Async commits (faster, slight risk)
commit_delay = 100                       # Microseconds to batch commits
commit_siblings = 5                      # Min concurrent transactions to delay
wal_writer_delay = 200ms                 # WAL writer sleep time

# Note: synchronous_commit=off means ~10ms of data loss risk on crash
# Acceptable for BigBrotr since Nostr events can be re-fetched

# ----------------------------------------------------------------------------
# Connection & Statement Timeout
# ----------------------------------------------------------------------------
statement_timeout = 0                    # No timeout (handled by app)
idle_in_transaction_session_timeout = 60000  # 60s idle transaction timeout

# ----------------------------------------------------------------------------
# Logging (minimal for performance)
# ----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                  # Docker handles logs
log_min_messages = warning
log_min_error_statement = error
log_statement = 'none'                   # Don't log statements (perf)
log_duration = off

# ----------------------------------------------------------------------------
# Autovacuum (tuned for high write throughput)
# ----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 30s                 # Check every 30s (default 1min)
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1     # 10% of table
autovacuum_analyze_scale_factor = 0.05   # 5% of table
autovacuum_vacuum_cost_delay = 2ms       # Faster vacuum

# ----------------------------------------------------------------------------
# Locale & Encoding
# ----------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# ============================================================================
# Performance Notes
# ============================================================================
# - synchronous_commit=off: ~2-3x write performance gain
# - shared_buffers=512MB: Good for 2GB RAM, increase for larger instances
# - For production with 8GB+ RAM:
#   - shared_buffers = 2GB
#   - effective_cache_size = 6GB
#   - work_mem = 16MB
#   - maintenance_work_mem = 512MB
# ============================================================================
