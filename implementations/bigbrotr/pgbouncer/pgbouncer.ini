# ============================================================================
# PGBouncer Configuration for BigBrotr
# ============================================================================
# Connection pooler between application services and PostgreSQL
# Optimized for high concurrency with asyncpg
# ============================================================================

[databases]
# Database connection to PostgreSQL
# Note: Password comes from userlist.txt
bigbrotr = host=postgres port=5432 dbname=bigbrotr

[pgbouncer]
# ----------------------------------------------------------------------------
# Connection Settings
# ----------------------------------------------------------------------------
listen_addr = 0.0.0.0
listen_port = 6432
unix_socket_dir =

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# ----------------------------------------------------------------------------
# Pool Mode - CRITICAL for asyncpg compatibility
# ----------------------------------------------------------------------------
# transaction: Connection returned after each transaction (recommended)
# session: Connection held for entire session (not recommended with pooling)
# statement: Connection returned after each statement (most aggressive)
#
# Use 'transaction' mode for asyncpg - it handles prepared statements correctly
pool_mode = transaction

# ----------------------------------------------------------------------------
# Pool Size Configuration
# ----------------------------------------------------------------------------
# These settings handle 1000+ concurrent application connections

# Default pool size per user/database pair
default_pool_size = 25

# Minimum pool size (kept open even when idle)
min_pool_size = 5

# Reserve connections for superuser
reserve_pool_size = 5
reserve_pool_timeout = 3

# Maximum connections to PostgreSQL (should match postgres max_connections)
max_db_connections = 100

# Maximum client connections (application side)
max_client_conn = 1000

# ----------------------------------------------------------------------------
# Timeout Settings
# ----------------------------------------------------------------------------
# Query timeout (0 = no timeout, handled by application)
query_timeout = 0

# Wait timeout for available connection from pool
query_wait_timeout = 120

# Close server connection after idle time
server_idle_timeout = 600

# Close client connection after idle time
client_idle_timeout = 0

# Connection lifetime (force reconnect after this time)
server_lifetime = 3600

# Login timeout
server_connect_timeout = 15
server_login_retry = 15

# ----------------------------------------------------------------------------
# Logging
# ----------------------------------------------------------------------------
log_connections = 0
log_disconnections = 0
log_pooler_errors = 1
stats_period = 60

# Admin console (for monitoring)
admin_users = admin
stats_users = admin

# ----------------------------------------------------------------------------
# TCP Settings
# ----------------------------------------------------------------------------
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

# ============================================================================
# Performance Notes for asyncpg + PGBouncer
# ============================================================================
#
# 1. Pool Mode: Use 'transaction' mode (not 'session' or 'statement')
#    - asyncpg works correctly with transaction mode
#    - Prepared statements are handled per-transaction
#
# 2. Connection Flow:
#    App (asyncpg pool: 20 conn)  PGBouncer (25 pool)  PostgreSQL (100 conn)
#
# 3. Scaling:
#    - 4 services  20 asyncpg connections = 80 app connections
#    - PGBouncer multiplexes to 25-100 PostgreSQL connections
#    - Can handle 1000 client connections (for future API)
#
# 4. Monitoring:
#    Connect to PGBouncer admin: psql -h localhost -p 6432 -U admin pgbouncer
#    Commands: SHOW POOLS; SHOW CLIENTS; SHOW SERVERS; SHOW STATS;
#
# ============================================================================
