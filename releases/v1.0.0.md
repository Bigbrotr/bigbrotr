# Release 1.0.0

**Release Date**: June 2025

## Overview

BigBrotr 1.0.0 is the initial prototype release of the Nostr data archiving and monitoring system. This version establishes the core functionality for collecting, monitoring, and archiving Nostr events from relays across the network, including support for both clearnet and Tor relays.

---

## Highlights

- **Full Event Archive** - Chronologically stores all events from every reachable relay
- **Relay Monitoring** - NIP-11 metadata and connectivity testing (openable, readable, writable)
- **Tor Support** - Built-in SOCKS5 proxy integration for .onion relay access
- **Multicore Processing** - Parallel relay processing using Python's multiprocessing
- **Docker Ready** - Complete containerized deployment with PostgreSQL and Tor proxy

---

## Architecture

### Monolithic Design

```
src/
├── bigbrotr.py              Database interface
├── event.py                 Event class
├── relay.py                 Relay class
├── relay_metadata.py        RelayMetadata class
├── utils.py                 Utility functions
├── compute_relay_metadata.py  Metadata computation
├── fetch_events.py          Event fetching
├── initializer.py           Database seeding
├── finder.py                Relay discovery (stub)
├── monitor.py               Health monitoring
└── syncronizer.py           Event synchronization
```

### Components

| Component | Lines | Description |
|-----------|-------|-------------|
| **Bigbrotr** | ~490 | PostgreSQL interface with psycopg2, batch operations |
| **Event** | ~140 | Nostr event class with signature verification |
| **Relay** | ~95 | Relay URL parsing with network detection |
| **RelayMetadata** | ~300 | NIP-11 metadata container |
| **utils.py** | ~450 | Cryptographic functions, URL parsing, TLD validation |

### Services

| Service | Lines | Status | Description |
|---------|-------|--------|-------------|
| **Initializer** | ~90 | Complete | Database seeding from seed_relays.txt |
| **Finder** | ~75 | Stub | Relay discovery (not implemented) |
| **Monitor** | ~200 | Complete | NIP-11 and connectivity checking |
| **Syncronizer** | ~400 | Complete | Event synchronization with time-window algorithm |

**Total**: ~2,500 lines of Python code

---

## Features

### Event Synchronization

- **Multicore Processing**: Uses Python's `multiprocessing.Pool` for parallel relay processing
- **Time-Window Stack Algorithm**: Binary search-based algorithm for handling large event volumes
- **Configurable Filters**: JSON-based event filtering by ids, authors, kinds, and tags
- **Incremental Sync**: Tracks last synchronized timestamp per relay

### Relay Monitoring

- **NIP-11 Support**: Full relay information document parsing
- **Connectivity Testing**: Tests openable, readable, writable capabilities
- **RTT Measurement**: Round-trip time tracking for all operations
- **PoW Support**: Respects `min_pow_difficulty` from NIP-11 limitation field

### Database

- **PostgreSQL**: Single database with four tables
- **psycopg2**: Synchronous PostgreSQL driver
- **CHAR Storage**: Event IDs stored as 64-character hex strings
- **Stored Functions**: `insert_event`, `insert_relay`, `insert_relay_metadata`, `delete_orphan_events`

### Configuration

- **Environment Variables**: All configuration via `.env` file
- **No Validation**: Minimal configuration validation at runtime
- **Hardcoded Defaults**: Some values hardcoded in source code

---

## Implementations

### Single Implementation

v1.0.0 has a single deployment configuration:

| Feature | Value |
|---------|-------|
| Event Storage | Full (tags, content) |
| Tor Support | Enabled |
| Database Admin | pgAdmin included |
| Ports | PostgreSQL: 5432, pgAdmin: 8080, Tor: 9050 |

---

## Database Schema

### Tables

| Table | Purpose |
|-------|---------|
| `events` | Nostr events with CHAR(64) IDs |
| `relays` | Known relay URLs with network type |
| `events_relays` | Event-relay junction with seen_at timestamps |
| `relay_metadata` | Time-series metadata snapshots |

### Events Table

```sql
CREATE TABLE events (
    id CHAR(64) PRIMARY KEY NOT NULL,
    pubkey CHAR(64) NOT NULL,
    created_at BIGINT NOT NULL,
    kind INT NOT NULL,
    tags JSONB NOT NULL,
    content TEXT NOT NULL,
    sig CHAR(128) NOT NULL
);
```

### Indexes

| Index | Type | Column(s) |
|-------|------|-----------|
| `idx_events_pubkey` | BTREE | pubkey |
| `idx_events_created_at` | BTREE | created_at DESC |
| `idx_events_kind` | BTREE | kind |
| `idx_events_kind_created_at` | BTREE | (kind, created_at DESC) |
| `idx_events_relays_event_id` | BTREE | event_id |
| `idx_events_relays_relay_url` | BTREE | relay_url |
| `idx_events_relays_seen_at` | BTREE | seen_at DESC |

---

## Technology Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| Python | 3.9+ | Primary language |
| PostgreSQL | latest | Primary storage |
| psycopg2-binary | 2.9.10 | Synchronous PostgreSQL driver |
| aiohttp | 3.11.18 | Async HTTP/WebSocket client |
| aiohttp-socks | 0.10.1 | SOCKS5 proxy support |
| secp256k1 | 0.14.0 | Cryptographic operations |
| bech32 | 1.2.0 | Bech32 encoding |
| pandas | 2.2.3 | Data processing |
| requests | 2.32.3 | HTTP client |

---

## Testing

- **No Unit Tests**: Test file exists as Jupyter notebook only (`tests/test.ipynb`)
- **Manual Testing**: All testing done manually during development

---

## Documentation

| Document | Purpose |
|----------|---------|
| `README.md` | Project overview with feature roadmap |
| `env.example` | Environment variable documentation |

---

## Docker Deployment

### Services

```yaml
services:
  database:        # PostgreSQL database
  pgadmin:         # pgAdmin web interface
  torproxy:        # Tor SOCKS5 proxy
  initializer:     # Database seeding (runs once)
  finder:          # Relay discovery (stub)
  monitor:         # Health monitoring
  syncronizer:     # Event synchronization
```

### Ports

| Service | Port |
|---------|------|
| PostgreSQL | 5432 |
| pgAdmin | 8080 |
| Tor SOCKS5 | 9050 |

---

## Configuration Reference

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DB_PORT` | 5432 | PostgreSQL port |
| `PGADMIN_PORT` | 8080 | pgAdmin web UI port |
| `SECRET_KEY` | - | Nostr private key (hex) |
| `PUBLIC_KEY` | - | Nostr public key (hex) |
| `POSTGRES_USER` | admin | Database username |
| `POSTGRES_PASSWORD` | admin | Database password |
| `POSTGRES_DB` | bigbrotr | Database name |
| `SEED_RELAYS_PATH` | ./seed_relays.txt | Initial relay list |
| `FINDER_FREQUENCY_HOUR` | 8 | Finder cycle interval (hours) |
| `MONITOR_FREQUENCY_HOUR` | 8 | Monitor cycle interval (hours) |
| `MONITOR_NUM_CORES` | 8 | CPU cores for monitoring |
| `SYNCRONIZER_NUM_CORES` | 8 | CPU cores for sync |
| `SYNCRONIZER_EVENT_FILTER` | {} | JSON event filter |

---

## Data

| Data | Count |
|------|-------|
| Seed Relays | 8,865 URLs |
| TLD Validation | ~1,500 valid TLDs from IANA |

---

## File Structure

```
bigbrotr/
├── src/
│   ├── bigbrotr.py           # Database interface
│   ├── event.py              # Event class
│   ├── relay.py              # Relay class
│   ├── relay_metadata.py     # Metadata class
│   ├── utils.py              # Utility functions
│   ├── compute_relay_metadata.py
│   ├── fetch_events.py
│   ├── initializer.py
│   ├── finder.py
│   ├── monitor.py
│   └── syncronizer.py
├── dockerfiles/
│   ├── finder
│   ├── initializer
│   ├── monitor
│   └── syncronizer
├── tests/
│   └── test.ipynb            # Jupyter notebook
├── docker-compose.yml
├── init.sql
├── requirements.txt
├── seed_relays.txt
├── env.example
├── README.md
├── LICENSE
└── .gitignore
```

---

## Known Limitations

| Limitation | Impact |
|------------|--------|
| No Async Database | Uses synchronous psycopg2 driver, blocking I/O |
| No Connection Pooling | Creates new connections per operation |
| Finder Not Implemented | Relay discovery is a stub (TODO) |
| No Unit Tests | Only Jupyter notebook for testing |
| CHAR Storage | Event IDs stored as hex strings (2x storage) |
| No Retry Logic | Database operations fail on transient errors |
| No Graceful Shutdown | Services don't handle SIGTERM properly |
| No State Persistence | Services restart from scratch on failure |
| No Config Validation | Invalid configuration crashes at runtime |
| Typo in Service Name | "syncronizer" instead of "synchronizer" |

---

## Upgrade Path

This is the initial release. For users upgrading to 2.0.0:

- **No Direct Migration**: Complete architectural rewrite
- **Fresh Deployment Required**: Deploy 2.0.0 as new instance
- **Re-sync Events**: Historical data must be re-synchronized from relays
- **Data Incompatible**: v1.0.0 CHAR storage incompatible with v2.0.0 BYTEA

---

## Contributors

- BigBrotr Contributors

---

## License

MIT License
