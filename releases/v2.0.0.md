# Release 2.0.0

**Release Date**: November 2025

## Overview

BigBrotr 2.0.0 is a complete architectural rewrite that transforms the project from a monolithic prototype into a professional, modular, and enterprise-ready system. This release introduces a three-layer architecture, comprehensive testing, multiple deployment configurations, and production-grade features.

---

## Highlights

- **Complete Architectural Rewrite** - Three-layer architecture (Core, Service, Implementation)
- **Multiple Implementations** - BigBrotr (full-featured) and LilBrotr (lightweight)
- **Multicore Processing** - Parallel event synchronization using aiomultiprocess
- **Professional Codebase** - Full type hints, Pydantic configuration, 174 unit tests
- **Docker Ready** - Complete containerized deployment with PostgreSQL, PGBouncer, and Tor

---

## Architecture

### Three-Layer Design

```
Implementation Layer (implementations/)
    ├── bigbrotr/     Full-featured (stores tags, content, Tor support)
    └── lilbrotr/     Lightweight (no tags/content, clearnet only)
          ↑ Uses
Service Layer (src/services/)
    Initializer, Finder, Monitor, Synchronizer
          ↑ Leverages
Core Layer (src/core/)
    Pool, Brotr, BaseService, Logger
```

### Components

| Component | Lines | Description |
|-----------|-------|-------------|
| **Pool** | ~410 | PostgreSQL connection pooling with asyncpg, retry logic, health checks |
| **Brotr** | ~430 | Database interface with stored procedure wrappers |
| **BaseService** | ~200 | Abstract service base with state persistence and lifecycle management |
| **Logger** | ~50 | Structured logging with key=value formatting |

### Services

| Service | Lines | Status | Description |
|---------|-------|--------|-------------|
| **Initializer** | ~310 | Complete | Database bootstrap, schema verification, relay seeding |
| **Finder** | ~220 | Complete | Relay discovery from external APIs |
| **Monitor** | ~400 | Complete | NIP-11/NIP-66 health monitoring with Tor support |
| **Synchronizer** | ~740 | Complete | Multicore event sync with incremental updates |
| **API** | - | Planned | REST API endpoints |
| **DVM** | - | Planned | NIP-90 Data Vending Machine |

**Total**: ~4,000+ lines of Python code (core + services)

---

## Features

### Event Synchronization

- **Multicore Processing**: Uses `aiomultiprocess` for parallel relay processing
- **Time-Window Stack Algorithm**: Efficiently handles large event volumes
- **Incremental Sync**: Per-relay timestamp tracking for efficient updates
- **Per-Relay Overrides**: Custom timeout configurations for specific relays
- **Graceful Shutdown**: Clean worker process termination

### Relay Monitoring

- **NIP-11 Support**: Full relay information document parsing
- **NIP-66 Support**: Relay capability testing (openable, readable, writable)
- **RTT Measurement**: Round-trip time tracking for all operations
- **Content Deduplication**: Hash-based deduplication for NIP-11/NIP-66 documents
- **Tor Support**: SOCKS5 proxy for .onion relay addresses

### Database

- **PostgreSQL 16+**: Full support with optimized schema
- **PGBouncer**: Connection pooling in transaction mode
- **BYTEA Storage**: 50% space savings for binary data (vs CHAR in v1.0.0)
- **Stored Procedures**: Atomic operations for data integrity
- **Pre-built Views**: Analytics views for statistics and metrics

### Configuration

- **YAML-Driven**: All configuration in YAML files
- **Pydantic Validation**: Type-safe configuration with validation
- **Environment Variables**: Secure handling of passwords and keys
- **Per-Implementation**: Each deployment has its own configuration

---

## Implementations

### BigBrotr (Full-Featured)

| Feature | Value |
|---------|-------|
| Event Storage | Full (tags, content, tagvalues) |
| Tor Support | Enabled |
| Concurrency | 10 parallel, 10 processes |
| Ports | PostgreSQL: 5432, PGBouncer: 6432, Tor: 9050 |

### LilBrotr (Lightweight)

| Feature | Value |
|---------|-------|
| Event Storage | Minimal (no tags/content, ~60% disk savings) |
| Tor Support | Disabled by default |
| Concurrency | 5 parallel connections |
| Ports | PostgreSQL: 5433, PGBouncer: 6433, Tor: 9051 |

---

## Database Schema

### Tables

| Table | Purpose |
|-------|---------|
| `relays` | Registry of known relay URLs with network type |
| `events` | Nostr events with BYTEA storage |
| `events_relays` | Event-relay junction with seen_at timestamps |
| `nip11` | Deduplicated NIP-11 documents |
| `nip66` | Deduplicated NIP-66 test results |
| `relay_metadata` | Time-series metadata snapshots |
| `service_state` | Service state persistence |

### Events Table (BigBrotr)

```sql
CREATE TABLE events (
    id BYTEA PRIMARY KEY,
    pubkey BYTEA NOT NULL,
    created_at BIGINT NOT NULL,
    kind INTEGER NOT NULL,
    tags JSONB NOT NULL,
    tagvalues TEXT[] GENERATED ALWAYS AS (tags_to_tagvalues(tags)) STORED,
    content TEXT NOT NULL,
    sig BYTEA NOT NULL
);
```

### Views

| View | Purpose |
|------|---------|
| `relay_metadata_latest` | Latest metadata per relay with joins |
| `events_statistics` | Global event statistics |
| `relays_statistics` | Per-relay statistics |
| `kind_counts_total` | Event counts by kind |
| `pubkey_counts_total` | Event counts by pubkey |

---

## Technology Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| Python | 3.9+ | Primary language |
| PostgreSQL | 16+ | Primary storage |
| asyncpg | 0.30.0 | Async PostgreSQL driver |
| Pydantic | 2.10.4 | Configuration validation |
| aiohttp | 3.13.2 | Async HTTP client |
| aiohttp-socks | 0.10.1 | SOCKS5 proxy support |
| aiomultiprocess | 0.9.1 | Multicore processing |
| nostr-tools | 1.4.1 | Nostr protocol library |
| PyYAML | 6.0.2 | YAML parsing |

---

## Testing

- **Unit Tests**: 174 tests covering all core and service components
- **Test Coverage**: Comprehensive mocking with pytest-asyncio
- **Pre-commit Hooks**: Ruff linting/formatting, mypy type checking

---

## Documentation

| Document | Purpose |
|----------|---------|
| `README.md` | Project overview and quick start |
| `CHANGELOG.md` | Version history (Keep a Changelog format) |
| `CONTRIBUTING.md` | Contribution guidelines |
| `SECURITY.md` | Security policy and vulnerability reporting |
| `CODE_OF_CONDUCT.md` | Contributor Covenant code of conduct |
| `docs/ARCHITECTURE.md` | Detailed architecture documentation |
| `docs/CONFIGURATION.md` | Complete configuration reference |
| `docs/DATABASE.md` | Database schema documentation |
| `docs/DEVELOPMENT.md` | Development guide |
| `docs/DEPLOYMENT.md` | Deployment instructions |

## GitHub Configuration

| File | Purpose |
|------|---------|
| `.github/workflows/ci.yml` | CI pipeline (lint, typecheck, test, build) |
| `.github/ISSUE_TEMPLATE/bug_report.yml` | Bug report template |
| `.github/ISSUE_TEMPLATE/feature_request.yml` | Feature request template |
| `.github/PULL_REQUEST_TEMPLATE.md` | Pull request template |

---

## Docker Deployment

### Services

```yaml
services:
  postgres:       # PostgreSQL 16 database
  pgbouncer:      # Connection pooling
  tor:            # Tor SOCKS5 proxy (optional)
  initializer:    # Database bootstrap (runs once)
  finder:         # Relay discovery
  monitor:        # Health monitoring
  synchronizer:   # Event synchronization
```

### Ports (BigBrotr)

| Service | Port |
|---------|------|
| PostgreSQL | 5432 |
| PGBouncer | 6432 |
| Tor SOCKS5 | 9050 |

---

## Data

| Data | Count |
|------|-------|
| Seed Relays | 8,865 URLs |

---

## File Structure

```
bigbrotr/
├── src/
│   ├── core/
│   │   ├── pool.py              # Connection pooling
│   │   ├── brotr.py             # Database interface
│   │   ├── base_service.py      # Abstract service base
│   │   └── logger.py            # Structured logging
│   └── services/
│       ├── __main__.py          # CLI entry point
│       ├── initializer.py       # Database bootstrap
│       ├── finder.py            # Relay discovery
│       ├── monitor.py           # Health monitoring
│       ├── synchronizer.py      # Event sync
│       ├── api.py               # REST API (planned)
│       └── dvm.py               # DVM service (planned)
├── implementations/
│   ├── bigbrotr/                # Full-featured
│   │   ├── yaml/                # Configuration files
│   │   ├── postgres/init/       # SQL schema
│   │   ├── data/seed_relays.txt
│   │   └── docker-compose.yaml
│   └── lilbrotr/                # Lightweight
│       ├── yaml/
│       ├── postgres/init/
│       └── docker-compose.yaml
├── tests/
│   ├── conftest.py              # Shared fixtures
│   └── unit/                    # 174 unit tests
├── docs/                        # Documentation
├── releases/                    # Release notes
├── .github/
│   ├── workflows/ci.yml         # CI pipeline
│   ├── ISSUE_TEMPLATE/          # Issue templates
│   └── PULL_REQUEST_TEMPLATE.md
├── CHANGELOG.md
├── CONTRIBUTING.md
├── SECURITY.md
├── CODE_OF_CONDUCT.md
└── requirements.txt
```

---

## Breaking Changes from 1.0.0

This is a complete rewrite with no backwards compatibility:

| Area | 1.0.0 | 2.0.0 |
|------|-------|-------|
| Architecture | Monolithic | Three-layer modular |
| Configuration | Environment variables | YAML + Pydantic |
| Database Driver | psycopg2 (sync) | asyncpg (async) |
| Storage | CHAR (hex strings) | BYTEA (50% savings) |
| Connection Pooling | None | PGBouncer + asyncpg pool |
| State Persistence | None | service_state table |
| Testing | Jupyter notebook | 174 unit tests |
| Service Name | syncronizer | synchronizer |

---

## Migration from 1.0.0

Due to the complete architectural rewrite, there is no direct migration path:

1. **Deploy Fresh**: Deploy 2.0.0 as a new instance
2. **Re-synchronize**: Re-sync events from relays
3. **Data Incompatible**: v1.0.0 CHAR storage cannot be imported to v2.0.0 BYTEA

---

## Known Limitations

| Limitation | Status |
|------------|--------|
| API service | Planned |
| DVM service | Planned |
| Integration tests | Unit tests only |
| Database backup automation | Not implemented |
| Prometheus metrics export | Not implemented |

---

## Future Roadmap

- [ ] API service with REST endpoints
- [ ] DVM service (NIP-90)
- [ ] Integration tests
- [ ] Prometheus metrics
- [ ] Admin dashboard
- [ ] Database backup automation

---

## Contributors

- BigBrotr Contributors

---

## License

MIT License
